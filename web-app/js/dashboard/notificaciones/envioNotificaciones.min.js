$.getCronList=$.contextAwarePathJS+"notificaciones/getCronList";$.loadCronInformation=$.contextAwarePathJS+"notificaciones/loadCronInformation";$.loadDataCron=$.contextAwarePathJS+"notificaciones/loadDataCron";$.deleteCron=$.contextAwarePathJS+"notificaciones/deleteCron";$(document).ready(function(){$("#hours-cron").timepicker({showMinutes:false,showPeriod:false,showLeadingZero:false,showPeriodLabels:false,hourText:"Hora"});$(".day-cron").timepicker({showPeriodLabels:false,showLeadingZero:false,hourText:"Hora",minuteText:"Minuto"});$(".day-cron").inputmask({mask:"99:99"});$("#newCronConfiguration-btn").on("click",function(a){a.preventDefault();loadDataCron(0)});$("#datepickerCron").datepicker({changeMonth:false,changeYear:false,dayNamesMin:["","","","","","",""],stepMonths:0,duration:0,onSelect:function(){var a=$(this).datepicker("getDate");$("#datepickerAux").datepicker("setDate",a);$("#datepickerCron").val(a.getDate())}}).focus(function(){var a=$("#datepickerAux").datepicker("getDate");$("#datepickerCron").datepicker("setDate",a);$("#datepickerCron").val(a.getDate());$(".ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-header, .ui-widget-header").remove()});$("#datepickerAux").datepicker();$("#saveCron-btn").on("click",function(a){a.preventDefault();validateForm()});$("#cron-tb").on("click","button.cronDetails",function(b){b.preventDefault();var a=this.getAttribute("data-id");loadDataCron(a)});$("#cron-tb").on("click","button.deleteCron",function(b){b.preventDefault();var a=this.getAttribute("data-id");deleteCron(a)});$(".only-number").keypress(function(a){return validarNumero(a)});getCronList();confugurationCron()});function getCronList(){$.ajax({type:"POST",dataType:"json",url:$.getCronList,contentType:"application/json",success:function(a){$("#cron-tb tbody").empty();if(a.cronList.length>0){$.each(a.cronList,function(c){var d="";if(c===0){d+="<tr></tr>"}d+="<tr>";d+='<td class="left tableTitleColor font12 paddingTop12 paddingRight12 paddingBottom5 paddingLeft10">';d+='<span class="textUpper">Configuración</span><br/>';d+='<span class="font14 tableDescriptionColor">'+this.cronExpression+"</span>";d+="</td>";d+='<td class="left tableTitleColor font12 paddingTop12 paddingRight12 paddingBottom5 paddingLeft10 textUpper">';d+="Plantilla SMS <br/>";$.each(this.templates,function(){if(this.tipoPlantilla.name==="SMS"){d+='<span class="font14 textUpper tableDescriptionColor">'+this.status+"</span><br/>"}});d+="</td>";d+='<td class="left tableTitleColor font12 paddingTop12 paddingRight12 paddingBottom5 paddingLeft10 textUpper">';d+="Plantilla email <br/>";$.each(this.templates,function(){if(this.tipoPlantilla.name==="EMAIL"){d+='<span class="font14 textUpper tableDescriptionColor">'+this.status+"</span><br/>"}});d+="</td>";d+='<td class="center colorWhite font14 paddingTop5 paddingRight12 paddingBottom5 paddingLeft10 textUpper">';d+='<button class="greenBox colorWhite width100 cronDetails" data-id="'+this.id+'" type="button">editar</button>';d+="</td>";d+='<td class="center colorWhite font14 paddingTop5 paddingRight12 paddingBottom5 paddingLeft10 textUpper">';d+='<button class="greenBox colorWhite width100 deleteCron" data-id="'+this.id+'" type="button">eliminar</button>';d+="</td>";d+="</tr>";$("#cron-tb tbody:last").append(d)})}else{var b="";b+="<tr></tr>";b+="<tr>";b+='<td colspan="3" class="left tableTitleColor font12 paddingTop12 paddingRight12 paddingBottom5 paddingLeft10 textUpper">';b+='<span class="font14 tableDescriptionColor">No hay envíos registrados</span>';b+="</td>";b+="</tr>";$("#cron-tb tbody:last").append(b)}},error:function(a,c,b){sweetAlert("Oops...","Algo salió mal, intenta nuevamente en unos minutos.","error")}})}function loadDataCron(a){$.ajax({type:"POST",dataType:"json",url:$.loadDataCron,data:"idCron="+a,cache:false,beforeSend:function(c,b){$('span[class*="help-block"]').each(function(){$(this).remove()});$("#smsOptions-div").empty();$("#emailOptions-div").empty()},success:function(c){$("#formAddCron")[0].reset();if(c.templatesSms.length>0||c.templatesEmail.length>0){$("#idCron").val(a);$("[name=cronOptions]").val([c.notificacionEnvio.cronOptions]);$("#hours-cron").val(c.notificacionEnvio.hour);$("#dayTime").val(c.notificacionEnvio.dayTime);$("#daysWeek").val(c.notificacionEnvio.weekDay);$("#weekTime").val(c.notificacionEnvio.weekTime);$("#monthTime").val(c.notificacionEnvio.monthTime);var d=new Date(2017,0,c.notificacionEnvio.dayMonth);$("#datepickerCron").datepicker("setDate",d);var b=$("#datepickerCron").datepicker("getDate").getDate();$("#datepickerCron").val(b);$("#datepickerAux").datepicker("setDate",d);$('input:radio[name="cronOptions"]').change(function(){if($(this).is(":checked")){selectFrequency($(this).val())}});selectFrequency($('input:radio[name="cronOptions"]:checked').val());fillTemplates(c);openModal("modalEnvio")}else{sweetAlert({html:false,title:"¡Atención!",text:"Para configurar el envío de mensajes, primero debe registrar plantillas al sistema.",type:"warning"})}},error:function(b,d,c){sweetAlert("Oops...","Algo salió mal, intenta nuevamente en unos minutos.","error")}})}function selectFrequency(a){switch(a){case"MINUTO":$("#eachHour").css("display","none");$("#eachDay").css("display","none");$("#eachWeek").css("display","none");$("#eachMonth").css("display","none");break;case"HORA":$("#eachHour").css("display","block");$("#eachDay").css("display","none");$("#eachWeek").css("display","none");$("#eachMonth").css("display","none");break;case"DIA":$("#eachHour").css("display","none");$("#eachDay").css("display","block");$("#eachWeek").css("display","none");$("#eachMonth").css("display","none");break;case"SEMANA":$("#eachHour").css("display","none");$("#eachDay").css("display","none");$("#eachWeek").css("display","block");$("#eachMonth").css("display","none");break;case"MES":$("#eachHour").css("display","none");$("#eachDay").css("display","none");$("#eachWeek").css("display","none");$("#eachMonth").css("display","block");break;default:$("#eachHour").css("display","none");$("#eachDay").css("display","none");$("#eachWeek").css("display","none");$("#eachMonth").css("display","none");break}}function saveCron(){var b=$("#formAddCron");var a=new FormData($(b)[0]);var c=$(b).attr("action");$.ajax({url:c,type:"POST",data:a,cache:false,contentType:false,processData:false,success:function(d){getCronList();cerrarModal("modalEnvio");sweetAlert({html:false,title:"¡Excelente!",text:"La configuración se ha guardado correctamente.",type:"success"})},error:function(d,f,e){sweetAlert("Oops...","Algo salió mal, intenta nuevamente en unos minutos.","error")}})}function deleteCron(a){swal({title:"¡Importante!",text:"¿Está seguro que desea cancelar el envío de mensajes definitivamente?",type:"warning",showCancelButton:true,cancelButtonText:"Me equivoque en la selección",confirmButtonColor:"#DD6B55",confirmButtonText:"Sí, continuar",closeOnConfirm:false},function(b){if(b){$.ajax({type:"POST",dataType:"json",url:$.deleteCron,data:"idCron="+a,success:function(c){if(c.error){sweetAlert("Oops...",c.mensaje,"error")}else{getCronList();sweetAlert({html:false,title:"¡Excelente!",text:"El envío de mansajes se ha eliminado correctamente.",type:"success"})}},error:function(c,e,d){sweetAlert("Oops...","Algo salió mal, intenta nuevamente en unos minutos.","error")}})}})}function validateForm(){var a=0;$('span[class*="help-block"]').each(function(){$(this).remove()});if($("input[name=cronOptions]:checked").length<=0){a++;cronErrorMessage("frequency","El campo es obligatorio")}else{if($("input[name=cronOptions]:checked").val()==="HORA"){if($("#hours-cron").val()===""){a++;cronErrorMessage("time","El campo es obligatorio")}else{if(!validateHour($("#hours-cron").val())){a++;cronErrorMessage("time","La hora del envío contiene un formato inválido")}}}if($("input[name=cronOptions]:checked").val()==="DIA"){if($("#dayTime").val()===""){a++;cronErrorMessage("time","Debe seleccionar la hora del envío de mensajes")}else{if(!validateHourTime($("#dayTime").val())){a++;cronErrorMessage("time","La hora del envío contiene un formato inválido")}}}if($("input[name=cronOptions]:checked").val()==="SEMANA"){if($("#weekTime").val()===""){a++;cronErrorMessage("time","Debe seleccionar la hora del envío de mensajes")}else{if(!validateHourTime($("#weekTime").val())){a++;cronErrorMessage("time","La hora del envío contiene un formato inválido")}}}if($("input[name=cronOptions]:checked").val()==="MES"){if($("#datepickerCron").val()===""){a++;cronErrorMessage("time","Debe seleccionar el día del envío de mensajes")}else{if(!validateDay($("#datepickerCron").val())){a++;cronErrorMessage("time","El día del envío contiene un formato inválido")}else{if($("#monthTime").val()===""){a++;cronErrorMessage("time","Debe seleccionar la hora del envío de mensajes")}else{if(!validateHourTime($("#monthTime").val())){a++;cronErrorMessage("time","La hora del envío contiene un formato inválido")}}}}}}if($("input[name=templateOptions]").length>0&&$("input[name=templateOptions]:checked").length<=0){a++;cronErrorMessage("template","Debe seleccionar una plantilla")}if(a===0){saveCron()}}function validateHourTime(a){return(/^(?:([01]?\d|2[0-3]):([0-5]?\d))$/.test(a))}function validateHour(a){return(/^(?:([01]?\d|2[0-3]))$/.test(a))}function validateDay(a){return(/^([1-9]|[12]\d|3[0-1])$/.test(a))}function validarNumero(c){var a=(document.all)?c.keyCode:c.which;if(a===13){return true}if(a===8){return true}if(a===9){return true}if(a===0){return true}var f=/^[0-9]$/;var d=String.fromCharCode(a);document.onkeypress=b;function b(g){return((window.event)?event.keyCode:g.keyCode)!==13}return f.test(d)}function confugurationCron(){$.ajax({type:"POST",dataType:"json",url:$.loadCronInformation,cache:false,success:function(a){$.each(a.listCronOptions,function(){var b=$('<input name="cronOptions" value="'+this+'" type="radio"> <span class="marginRight10">'+this+"</span>");b.appendTo("#cronOptions-div")});$("#daysWeek").find("option").remove();$.each(a.listweekDayOptions,function(c,b){$("#daysWeek").append($("<option />").val(c).text(b.name))})},error:function(a,c,b){sweetAlert("Oops...","Algo salió mal, intenta nuevamente en unos minutos.","error")}})}function cronErrorMessage(a,b){$("#"+a+"-control").html("<span class='help-block marginRight25'><small style='color: red;'>"+b+"</small></span>")}function fillTemplates(a){if(a.templatesSms.length>0){$.each(a.templatesSms,function(){var b=$('<input name="templateOptions" value="'+this.id+'" type="checkbox"> <span class="marginRight10"> '+this.status+"</span>");b.appendTo("#smsOptions-div")});$("#smsTemplateConfig-div").css("display","block")}else{$("#smsTemplateConfig-div").css("display","none")}if(a.templatesEmail.length>0){$.each(a.templatesEmail,function(){var b=$('<input name="templateOptions" value="'+this.id+'" type="checkbox"> <span class="marginRight10"> '+this.status+"</span>");b.appendTo("#emailOptions-div")});$("#emailTemplateConfig-div").css("display","block")}else{$("#emailTemplateConfig-div").css("display","none")}$.each(a.notificacionEnvio.templateOptions,function(){$("input[name=templateOptions][value='"+this+"']").prop("checked",true)})};
